<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ครูพร้อมสอน - To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark {
            background-color: #1f2937; /* gray-800 */
            color: #f3f4f6; /* gray-100 */
        }
        .dark .bg-white { background-color: #374151; /* gray-700 */ }
        .dark .text-gray-800 { color: #f3f4f6; /* gray-100 */ }
        .dark .text-gray-700 { color: #d1d5db; /* gray-300 */ }
        .dark .text-gray-600 { color: #d1d5db; /* gray-300 */ }
        .dark .text-gray-500 { color: #9ca3af; /* gray-400 */ }
        .dark .text-gray-400 { color: #9ca3af; /* gray-400 for due date */ }
        .dark .border-gray-300 { border-color: #4b5563; /* gray-600 */ }
        .dark .hover\:bg-gray-100:hover { background-color: #4b5563; /* gray-600 */ }
        .dark .hover\:bg-gray-50:hover { background-color: #4b5563; /* gray-600 for task item hover */ }
        .dark .hover\:bg-blue-600:hover { background-color: #3b82f6; }
        .dark input[type="text"], .dark textarea, .dark input[type="datetime-local"] {
            background-color: #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
            border-color: #6b7280; /* gray-500 */
        }
        .dark input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .dark .ring-indigo-500:focus {
            --tw-ring-color: #6366f1 !important;
        }
        .task-item:hover .task-actions {
            opacity: 1;
        }
        .task-actions {
            opacity: 0.2;
            transition: opacity 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }
         .task-item:hover .task-actions button {
            opacity: 0.7;
        }
        .task-item .task-actions button:hover {
             opacity: 1;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #777; }
        .tab-button.active {
            border-bottom-width: 2px;
            border-color: #6366f1;
            color: #6366f1;
            font-weight: 600;
        }
        .dark .tab-button.active {
            border-color: #818cf8;
            color: #818cf8;
        }
        .progress-bar-fill { transition: width 0.3s ease-out; }
        .due-date-text { font-size: 0.8rem; }
        .overdue { color: #ef4444; }
        .dark .overdue { color: #f87171; }
        .date-input-container { position: relative; }
        .date-input-container input[type="datetime-local"] { padding-right: 2.5rem; }
        .clear-date-btn {
            position: absolute; right: 0.5rem; top: 50%;
            transform: translateY(-50%); background: none; border: none;
            cursor: pointer; color: #9ca3af;
        }
        .dark .clear-date-btn { color: #6b7280; }
        .clear-date-btn:hover { color: #ef4444; }
        .dark .clear-date-btn:hover { color: #f87171; }

        #auth-container { text-align: center; margin-top: 2rem; }
        #user-info { font-size: 0.875rem; color: #4b5563; }
        .dark #user-info { color: #d1d5db; }
        .hidden { display: none !important; }
        .category-done .task-item .task-actions .delete-task-btn { display: none; } /* Hide delete for non-custom in Done */
        .category-done .task-item.custom-task .task-actions .delete-task-btn { display: inline-flex; } /* Show for custom in Done */
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-5xl mx-auto p-4 sm:p-6 md:p-8">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-2">
                <h1 id="app-title" class="text-3xl sm:text-4xl font-bold text-indigo-600 dark:text-indigo-400">ครูพร้อมสอน</h1>
                <div id="auth-controls" class="flex items-center space-x-3 mt-2 sm:mt-0">
                    </div>
            </div>
            <div id="user-info" class="text-sm text-gray-600 dark:text-gray-300 text-center sm:text-right mb-2"></div>
            <p id="app-subtitle" class="text-gray-600 dark:text-gray-300 text-center sm:text-left">
                <span class="lang-th">รายการสิ่งที่ต้องทำสำหรับครูไทยยุคใหม่</span>
                <span class="lang-en hidden">Modern To-Do List for Thai Teachers</span>
            </p>
        </header>

        <div id="main-content" class="hidden">
            <div class="flex items-center justify-end space-x-3 mb-4">
                 <button id="language-toggle" class="text-sm font-medium text-indigo-600 dark:text-indigo-300 hover:underline">English</button>
                 <button id="dark-mode-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
                <button id="export-csv" class="text-sm font-medium bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-md shadow">
                    <span class="lang-th">ส่งออก CSV</span>
                    <span class="lang-en hidden">Export CSV</span>
                </button>
            </div>
            <nav class="mb-6 pb-2 border-b border-gray-300 dark:border-gray-600">
                <ul class="flex space-x-2 sm:space-x-4 overflow-x-auto">
                    <li><button data-view="category" class="view-tab tab-button py-2 px-3 text-sm sm:text-base">
                        <span class="lang-th">ตามหมวดหมู่</span><span class="lang-en hidden">By Category</span>
                    </button></li>
                    <li><button data-view="today" class="view-tab tab-button py-2 px-3 text-sm sm:text-base">
                        <span class="lang-th">รายการวันนี้</span><span class="lang-en hidden">Today's List</span>
                    </button></li>
                    <li><button data-view="time_morning" class="view-tab tab-button py-2 px-3 text-sm sm:text-base">
                        <span class="lang-th">ช่วงเช้า</span><span class="lang-en hidden">Morning</span>
                    </button></li>
                    <li><button data-view="time_afternoon" class="view-tab tab-button py-2 px-3 text-sm sm:text-base">
                        <span class="lang-th">ช่วงบ่าย/เย็น</span><span class="lang-en hidden">Afternoon/Evening</span>
                    </button></li>
                    <li><button data-view="time_night" class="view-tab tab-button py-2 px-3 text-sm sm:text-base">
                        <span class="lang-th">ช่วงกลางคืน</span><span class="lang-en hidden">Night</span>
                    </button></li>
                </ul>
            </nav>
            <main id="task-area" class="space-y-6">
                </main>
        </div>

        <div id="login-prompt" class="text-center p-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-100">
                <span class="lang-th">กรุณาเข้าสู่ระบบเพื่อใช้งาน</span>
                <span class="lang-en hidden">Please Login to Use the App</span>
            </h2>
            <p class="text-gray-600 dark:text-gray-300 mb-6">
                <span class="lang-th">บันทึกและซิงค์รายการสิ่งที่ต้องทำของคุณผ่านอุปกรณ์ต่างๆ</span>
                <span class="lang-en hidden">Save and sync your to-do lists across devices.</span>
            </p>
            </div>

        <footer class="mt-12 text-center text-xs text-gray-500 dark:text-gray-400">
            <p>ครูพร้อมสอน (Kru Prom Sorn) v1.4 - Done Category</p>
        </footer>
    </div>

    <script>
        // --- START FIREBASE CONFIG ---
        const firebaseConfig = {
 apiKey: "AIzaSyDPBM-u6syLdJgdBw6gD2PTPmcc1zB2vpI",
    authDomain: "to-do-2ace7.firebaseapp.com",
    projectId: "to-do-2ace7",
    storageBucket: "to-do-2ace7.firebasestorage.app",
    messagingSenderId: "219398822900",
    appId: "1:219398822900:web:26782cf78f1aa9d76937a1",
    measurementId: "G-T8QK1EFHPL"
        };
        // --- END FIREBASE CONFIG ---

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        let currentUser = null;
        let appData = {
            currentLanguage: 'th',
            darkMode: false,
            currentView: 'category',
        };
        let userTasks = []; 

        const defaultTasksStructure = [
            // ... (Existing categories - Before Start of Term, Daily Routine, Before Bed)
            // Ensure all items have: completed: false, isCustom: false, dueDate: null, notificationShown: false
            // AND originalCategoryId: null (new property)
            {
                id: 'term_start', title_th: 'ก่อนเปิดภาคเรียน', title_en: 'Before Start of Term',
                items: [
                    { id: 'bst001', text_th: 'จัดโต๊ะ เก้าอี้ และสื่อการเรียนการสอน', text_en: 'Arrange desks, chairs, and teaching materials', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bst002', text_th: 'วางแผนรายปี / หน่วยการสอน', text_en: 'Annual / Unit lesson planning', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bst003', text_th: 'เตรียมแฟ้มสะสมงานนักเรียน', text_en: 'Prepare student portfolios', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bst004', text_th: 'ประชุมวางแผนกับครูประจำชั้นและฝ่ายวิชาการ', text_en: 'Planning meeting with homeroom teachers and academic department', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bst005', text_th: 'ตรวจสอบชื่อและข้อมูลพื้นฐานของนักเรียน', text_en: 'Verify student names and basic information', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bst006', text_th: 'จัดทำป้ายชื่อนักเรียนและตกแต่งห้องเรียน', text_en: 'Create student name tags and decorate classroom', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bst007', text_th: 'เตรียมเอกสารสำหรับผู้ปกครอง (กำหนดการ, สิ่งที่ต้องเตรียม)', text_en: 'Prepare documents for parents (schedule, required items)', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                ]
            },
            {
                id: 'daily_routine', title_th: 'กิจวัตรประจำวัน', title_en: 'Daily Routine',
                subCategories: [
                    {
                        id: 'daily_before_class', title_th: 'ก่อนเริ่มสอน', title_en: 'Before Class',
                        items: [
                            { id: 'dbc001', text_th: 'เช็คชื่อนักเรียน', text_en: 'Check student attendance', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dbc002', text_th: 'เตรียมใบงานและสื่อการสอนสำหรับวันนี้', text_en: 'Prepare worksheets and teaching materials for the day', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dbc003', text_th: 'ทบทวนแผนการสอนของวันนี้', text_en: 'Review today\'s lesson plan', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dbc004', text_th: 'ทักทายนักเรียนที่ประตูห้องเรียน', text_en: 'Greeting students at the door', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dbc005', text_th: 'ตรวจสอบความสะอาดและความเรียบร้อยของห้องเรียน', text_en: 'Check classroom cleanliness and orderliness', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dbc006', text_th: 'ประชุมทีมสั้นๆ หรือประชุมครู (ถ้ามี)', text_en: 'Brief team talk or staff meeting (if any)', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                        ]
                    },
                    {
                        id: 'daily_after_class', title_th: 'หลังเลิกสอน', title_en: 'After Class',
                        items: [
                            { id: 'dac001', text_th: 'ตรวจการบ้าน / ให้คะแนนงานนักเรียน', text_en: 'Mark homework / Grade student assignments', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dac002', text_th: 'จดบันทึกพฤติกรรมนักเรียนหรือความก้าวหน้า', text_en: 'Document student behavior or progress', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dac003', text_th: 'เตรียมสื่อและอุปกรณ์การสอนสำหรับวันพรุ่งนี้', text_en: 'Prepare materials and equipment for next day', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                            { id: 'dac004', text_th: 'ประชุมครู / ติดตามงานเอกสารราชการ (ถ้ามี)', text_en: 'Teacher meeting / Follow up on official documents (if any)', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                        ]
                    }
                ]
            },
            {
                id: 'before_bed', title_th: 'ก่อนนอน (ส่วนตัว)', title_en: 'Before Bed (Personal)',
                items: [
                    { id: 'bb001', text_th: 'ทบทวนแผนการสอนพรุ่งนี้ (คร่าวๆ)', text_en: 'Briefly review tomorrow\'s lesson plan', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bb002', text_th: 'สรุปสิ่งที่ทำได้ดี / สิ่งที่ต้องปรับปรุง', text_en: 'Reflect on today: good/needs work', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bb003', text_th: 'ดื่มน้ำ / พักผ่อน', text_en: 'Drink water / Relax', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bb004', text_th: 'เตือนให้เข้านอนตรงเวลา / ตั้งนาฬิกาปลุก', text_en: 'Reminder to sleep on time / Set alarm', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                    { id: 'bb005', text_th: 'เตรียมเสื้อผ้าสำหรับวันพรุ่งนี้', text_en: 'Set out clothes for tomorrow', completed: false, isCustom: false, dueDate: null, notificationShown: false, originalCategoryId: null },
                ]
            },
            { // New "Done" category
                id: 'done',
                title_th: 'เรียบร้อยแล้ว',
                title_en: 'Done',
                items: [] // Starts empty
            }
        ];

        const appTitle = document.getElementById('app-title');
        const authControlsUI = document.getElementById('auth-controls');
        const userInfoUI = document.getElementById('user-info');
        const mainContentUI = document.getElementById('main-content');
        const loginPromptUI = document.getElementById('login-prompt');
        const languageToggleBtn = document.getElementById('language-toggle');
        const darkModeToggleBtn = document.getElementById('dark-mode-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const exportCsvBtn = document.getElementById('export-csv');
        const taskArea = document.getElementById('task-area');
        const viewTabs = document.querySelectorAll('.view-tab');

        const getUserDocRef = () => currentUser ? db.collection('users').doc(currentUser.uid) : null;

        const saveUserDataToFirestore = async () => {
            if (!currentUser) return;
            const userDocRef = getUserDocRef();
            try {
                const tasksToSave = JSON.parse(JSON.stringify(userTasks)).map(category => {
                    const cleanCategory = { ...category };
                    delete cleanCategory.editingDueDate; // Ensure temporary flags are not saved
                    if (cleanCategory.items) {
                        cleanCategory.items = cleanCategory.items.map(item => {
                            const { editingDueDate, ...restOfItem } = item;
                            return restOfItem;
                        });
                    }
                    if (cleanCategory.subCategories) {
                         cleanCategory.subCategories = cleanCategory.subCategories.map(subCat => {
                            const cleanSubCat = { ...subCat };
                             delete cleanSubCat.editingDueDate;
                             if (cleanSubCat.items) {
                                cleanSubCat.items = cleanSubCat.items.map(item => {
                                    const { editingDueDate, ...restOfItem } = item;
                                    return restOfItem;
                                });
                            }
                            return cleanSubCat;
                        });
                    }
                    return cleanCategory;
                });
                await userDocRef.set({ settings: appData, tasks: tasksToSave }, { merge: true });
                console.log("User data saved to Firestore.");
            } catch (error) {
                console.error("Error saving user data to Firestore: ", error);
            }
        };

        const loadUserDataFromFirestore = async () => {
            if (!currentUser) return;
            const userDocRef = getUserDocRef();
            try {
                const doc = await userDocRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    appData = { ...appData, ...(data.settings || {}) };
                    
                    // Merge tasks: ensure all default categories exist, and new properties are added
                    const defaultStructureCopy = JSON.parse(JSON.stringify(defaultTasksStructure));
                    const firestoreTasks = data.tasks || [];

                    userTasks = defaultStructureCopy.map(defaultCat => {
                        const firestoreCat = firestoreTasks.find(fc => fc.id === defaultCat.id);
                        if (firestoreCat) {
                            // Merge items, prioritizing Firestore for existing, adding new default items
                            let mergedItems = defaultCat.items ? defaultCat.items.map(defaultItem => {
                                const firestoreItem = firestoreCat.items.find(fi => fi.id === defaultItem.id);
                                return firestoreItem ? { ...defaultItem, ...firestoreItem, originalCategoryId: firestoreItem.originalCategoryId !== undefined ? firestoreItem.originalCategoryId : defaultItem.originalCategoryId } : defaultItem;
                            }) : [];

                            // Add custom tasks from Firestore
                            if (firestoreCat.items) {
                                firestoreCat.items.forEach(fi => {
                                    if (fi.isCustom && !mergedItems.some(mi => mi.id === fi.id)) {
                                        mergedItems.push(fi);
                                    }
                                });
                            }
                            defaultCat.items = mergedItems;

                            // Handle subcategories similarly
                            if (defaultCat.subCategories) {
                                defaultCat.subCategories = defaultCat.subCategories.map(defaultSubCat => {
                                    const firestoreSubCat = firestoreCat.subCategories?.find(fsc => fsc.id === defaultSubCat.id);
                                    if (firestoreSubCat) {
                                        let mergedSubItems = defaultSubCat.items.map(defaultSubItem => {
                                            const firestoreSubItem = firestoreSubCat.items.find(fsi => fsi.id === defaultSubItem.id);
                                            return firestoreSubItem ? { ...defaultSubItem, ...firestoreSubItem, originalCategoryId: firestoreSubItem.originalCategoryId !== undefined ? firestoreSubItem.originalCategoryId : defaultSubItem.originalCategoryId } : defaultSubItem;
                                        });
                                        firestoreSubCat.items.forEach(fsi => {
                                            if (fsi.isCustom && !mergedSubItems.some(msi => msi.id === fsi.id)) {
                                                mergedSubItems.push(fsi);
                                            }
                                        });
                                        defaultSubCat.items = mergedSubItems;
                                    }
                                    return defaultSubCat;
                                });
                            }
                        }
                        return defaultCat;
                    });
                    // Ensure "Done" category exists
                    if (!userTasks.find(cat => cat.id === 'done')) {
                        userTasks.push(JSON.parse(JSON.stringify(defaultTasksStructure.find(cat => cat.id === 'done'))));
                    }

                    console.log("User data loaded and merged from Firestore.");
                } else {
                    console.log("New user, initializing default data structure.");
                    userTasks = JSON.parse(JSON.stringify(defaultTasksStructure));
                    appData = { currentLanguage: 'th', darkMode: false, currentView: 'category' };
                    await saveUserDataToFirestore();
                }
            } catch (error) {
                console.error("Error loading user data from Firestore: ", error);
                userTasks = JSON.parse(JSON.stringify(defaultTasksStructure));
            }
            applyDarkMode();
            updateUIForLanguage();
            viewTabs.forEach(t => t.classList.remove('active'));
            const activeTab = document.querySelector(`.view-tab[data-view="${appData.currentView}"]`) || document.querySelector('.view-tab[data-view="category"]');
            activeTab.classList.add('active');
            if (!appData.currentView) appData.currentView = activeTab.dataset.view; // Ensure currentView is set
            renderTasks();
            checkAndShowReminders();
        };

        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                userInfoUI.textContent = `${getLocalizedText({text_th: "สวัสดี", text_en: "Hello"})}, ${user.displayName || user.email}!`;
                authControlsUI.innerHTML = `<button id="logout-button" class="text-sm font-medium bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-md shadow"><span class="lang-th">ออกจากระบบ</span><span class="lang-en hidden">Logout</span></button>`;
                document.getElementById('logout-button').addEventListener('click', signOutUser);
                mainContentUI.classList.remove('hidden');
                loginPromptUI.classList.add('hidden');
                await loadUserDataFromFirestore();
            } else {
                userInfoUI.textContent = '';
                const loginButtonHTML = `<button id="login-google-button" class="text-sm font-medium bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-md shadow flex items-center"><svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="white"><path d="M22.56,12.25C22.56,11.47 22.49,10.72 22.36,10H12V14.26H17.94C17.71,15.61 16.95,16.79 15.82,17.57V20.06H19.11C21.2,18.24 22.56,15.47 22.56,12.25Z"/><path d="M12,23C14.97,23 17.5,22.04 19.11,20.06L15.82,17.57C14.79,18.27 13.49,18.69 12,18.69C9.32,18.69 7.03,17.06 6.16,14.71H2.74V17.24C4.39,20.71 7.89,23 12,23Z"/><path d="M6.16,14.71C5.94,14.06 5.81,13.35 5.81,12.62C5.81,11.88 5.94,11.17 6.16,10.52V8H2.74C1.76,9.92 1.11,11.7 1.11,13.38C1.11,15.07 1.76,16.85 2.74,18.77L6.16,14.71Z"/><path d="M12,5.81C13.81,5.81 15.22,6.49 15.82,7.06L19.17,3.71C17.5,2.09 14.97,1 12,1C7.89,1 4.39,3.29 2.74,6.76L6.16,9.29C7.03,6.94 9.32,5.81 12,5.81Z"/></svg><span class="lang-th">เข้าสู่ระบบด้วย Google</span><span class="lang-en hidden">Login with Google</span></button>`;
                authControlsUI.innerHTML = loginButtonHTML;
                const existingLoginBtnInPrompt = loginPromptUI.querySelector('#login-google-button');
                if (existingLoginBtnInPrompt) existingLoginBtnInPrompt.remove();
                loginPromptUI.insertAdjacentHTML('beforeend', loginButtonHTML);
                document.querySelectorAll('#login-google-button').forEach(btn => btn.addEventListener('click', signInWithGoogle));
                mainContentUI.classList.add('hidden');
                loginPromptUI.classList.remove('hidden');
                userTasks = [];
                taskArea.innerHTML = '';
            }
            updateUIForLanguage();
        });

        const getLocalizedText = (item, fieldPrefix = 'text') => item[`${fieldPrefix}_${appData.currentLanguage}`] || item[`${fieldPrefix}_en`];
        const generateId = () => `custom_${new Date().getTime()}_${Math.random().toString(36).substr(2, 9)}`;
        const formatDueDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString(appData.currentLanguage === 'th' ? 'th-TH' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: appData.currentLanguage === 'en' });
        };

        const requestNotificationPermission = async () => { /* ... same ... */ 
            if (!('Notification' in window)) {
                alert(getLocalizedText({text_th: 'เบราว์เซอร์นี้ไม่รองรับการแจ้งเตือน', text_en: 'This browser does not support desktop notification'}));
                return false;
            }
            if (Notification.permission === 'granted') return true;
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        };
        const showNotification = (task) => { /* ... same ... */ 
            const title = getLocalizedText({text_th: '🔔 ครูพร้อมสอน: แจ้งเตือนงาน', text_en: '🔔 Teacher\'s Prep: Task Reminder'});
            const body = getLocalizedText(task);
            const options = { body: body, icon: 'https://placehold.co/48x48/6366f1/ffffff?text=🔔' };
            new Notification(title, options);
        };
        const checkAndShowReminders = () => { /* ... same, uses userTasks ... */ 
            if (!currentUser || !userTasks || userTasks.length === 0) return; 
            const now = new Date();
            let madeChanges = false;
            userTasks.forEach(category => {
                const itemsToScan = category.items || (category.subCategories ? category.subCategories.flatMap(sc => sc.items) : []);
                itemsToScan.forEach(task => {
                    if (task.dueDate && !task.notificationShown) {
                        const dueDate = new Date(task.dueDate);
                        if (now >= dueDate) {
                            if (Notification.permission === 'granted') {
                                showNotification(task);
                                task.notificationShown = true;
                                madeChanges = true;
                            }
                        }
                    }
                });
            });
            if (madeChanges) saveUserDataToFirestore();
        };

        const renderTasks = () => {
            if (!currentUser) { taskArea.innerHTML = ''; return; }
            taskArea.innerHTML = '';
            let categoriesToRender = [];
            const doneCategoryFromData = userTasks.find(cat => cat.id === 'done'); // Get the "Done" category separately

            if (appData.currentView === 'category') {
                userTasks.filter(cat => cat.id !== 'done').forEach(category => { // Exclude "Done" from normal flow
                    if (category.items) categoriesToRender.push(JSON.parse(JSON.stringify(category)));
                    else if (category.subCategories) category.subCategories.forEach(subCat => categoriesToRender.push(JSON.parse(JSON.stringify(subCat))));
                });
                if (doneCategoryFromData) { // Add "Done" category at the end for "category" view
                    categoriesToRender.push(JSON.parse(JSON.stringify(doneCategoryFromData)));
                }
            } else { // For other views, filter out "Done" tasks
                let tempCategories = [];
                 userTasks.filter(cat => cat.id !== 'done').forEach(category => {
                    if (category.items) tempCategories.push(JSON.parse(JSON.stringify(category)));
                    else if (category.subCategories) category.subCategories.forEach(subCat => tempCategories.push(JSON.parse(JSON.stringify(subCat))));
                });

                if (appData.currentView === 'today') {
                    const dailyRoutine = tempCategories.filter(cat => cat.id === 'daily_before_class' || cat.id === 'daily_after_class');
                    categoriesToRender.push(...dailyRoutine);
                } else if (appData.currentView === 'time_morning') {
                    const beforeClass = tempCategories.find(cat => cat.id === 'daily_before_class');
                    if (beforeClass) categoriesToRender.push(beforeClass);
                } else if (appData.currentView === 'time_afternoon') {
                    const afterClass = tempCategories.find(cat => cat.id === 'daily_after_class');
                    if (afterClass) categoriesToRender.push(afterClass);
                } else if (appData.currentView === 'time_night') {
                    const beforeBed = tempCategories.find(cat => cat.id === 'before_bed'); // Assuming 'before_bed' is a top-level ID in tempCategories
                    if (beforeBed) categoriesToRender.push(beforeBed);
                }
            }


            categoriesToRender.forEach(category => {
                const isDoneCategory = category.id === 'done';
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `bg-white dark:bg-gray-700 shadow-lg rounded-xl p-4 sm:p-6 ${isDoneCategory ? 'category-done' : ''}`;
                const categoryTitle = document.createElement('h2');
                categoryTitle.className = 'text-xl sm:text-2xl font-semibold mb-2 text-gray-800 dark:text-gray-100 border-b-2 border-indigo-500 dark:border-indigo-400 pb-2';
                categoryTitle.textContent = getLocalizedText(category, 'title');
                categoryDiv.appendChild(categoryTitle);

                if (!isDoneCategory) { // Only show progress bar for non-Done categories
                    const totalTasks = category.items.length; // Should count only incomplete if we want "progress"
                    const incompleteTasks = category.items.filter(task => !task.completed).length; // This is better for progress
                    const progressPercentage = totalTasks > 0 ? ((totalTasks - incompleteTasks) / totalTasks) * 100 : 0;

                    const progressContainerDiv = document.createElement('div');
                    progressContainerDiv.className = 'flex items-center my-3';
                    const progressBarBg = document.createElement('div');
                    progressBarBg.className = 'w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5 mr-3';
                    const progressBarFill = document.createElement('div');
                    progressBarFill.className = 'progress-bar-fill bg-indigo-500 dark:bg-indigo-400 h-2.5 rounded-full';
                    progressBarFill.style.width = `${progressPercentage}%`;
                    progressBarBg.appendChild(progressBarFill);
                    progressContainerDiv.appendChild(progressBarBg);
                    const progressText = document.createElement('span');
                    progressText.className = 'text-xs text-gray-600 dark:text-gray-300 whitespace-nowrap';
                    progressText.textContent = `${Math.round(progressPercentage)}%`;
                    progressContainerDiv.appendChild(progressText);
                    categoryDiv.appendChild(progressContainerDiv);
                } else {
                    const doneCount = document.createElement('p');
                    doneCount.className = 'text-sm text-gray-500 dark:text-gray-400 my-3';
                    doneCount.textContent = `${getLocalizedText({text_th: "จำนวนงานที่เสร็จสิ้น:", text_en: "Completed tasks:"})} ${category.items.length}`;
                    categoryDiv.appendChild(doneCount);
                }


                const ul = document.createElement('ul');
                ul.className = 'space-y-3';
                category.items.forEach(task => {
                    const li = document.createElement('li');
                    li.className = `task-item flex items-start justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-150 ${task.isCustom ? 'custom-task' : ''}`;
                    li.dataset.taskId = task.id;
                    li.dataset.categoryId = category.id; 
                    const taskMainContentDiv = document.createElement('div');
                    taskMainContentDiv.className = 'flex-grow mr-2';
                    const taskTopRowDiv = document.createElement('div');
                    taskTopRowDiv.className = 'flex items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = task.completed;
                    checkbox.className = 'form-checkbox h-5 w-5 text-indigo-600 dark:text-indigo-400 border-gray-300 dark:border-gray-500 rounded focus:ring-indigo-500 dark:focus:ring-indigo-400 mr-3 flex-shrink-0 mt-1';
                    checkbox.addEventListener('change', () => toggleTaskComplete(category.id, task.id, task.originalCategoryId)); // Pass originalCategoryId
                    const taskTextSpan = document.createElement('span');
                    taskTextSpan.textContent = getLocalizedText(task);
                    taskTextSpan.className = `text-gray-700 dark:text-gray-200 ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : ''}`;
                    if (task.isCustom && !isDoneCategory) { // Allow edit only if custom and not in Done category
                        taskTextSpan.classList.add('cursor-pointer', 'hover:text-indigo-500', 'dark:hover:text-indigo-300');
                        taskTextSpan.addEventListener('click', () => enableTaskEdit(taskTextSpan, category.id, task.id));
                    }
                    taskTopRowDiv.appendChild(checkbox);
                    taskTopRowDiv.appendChild(taskTextSpan);
                    taskMainContentDiv.appendChild(taskTopRowDiv);

                    const dueDateContainer = document.createElement('div');
                    dueDateContainer.className = 'ml-8 mt-1 text-xs';
                    if (task.editingDueDate) { /* ... date input rendering ... */ }
                    else if (task.dueDate) { /* ... date display rendering ... */ }
                    taskMainContentDiv.appendChild(dueDateContainer); // Simplified for brevity
                    li.appendChild(taskMainContentDiv);

                    const actionButtonsDiv = document.createElement('div');
                    actionButtonsDiv.className = 'task-actions flex-shrink-0 ml-2 space-x-1';
                    if (!isDoneCategory) { // Due date button only for non-Done tasks
                        const dueDateBtn = document.createElement('button');
                        dueDateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`;
                        dueDateBtn.className = 'text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 rounded-full';
                        dueDateBtn.title = getLocalizedText({text_th: 'ตั้งวันที่ครบกำหนด', text_en: 'Set Due Date'});
                        dueDateBtn.addEventListener('click', () => toggleDueDateEdit(category.id, task.id, true));
                        actionButtonsDiv.appendChild(dueDateBtn);
                    }
                    if (task.isCustom) { // Delete button for custom tasks (even in Done)
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 delete-task-btn" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                        deleteBtn.className = 'text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 rounded-full delete-task-btn';
                        deleteBtn.title = appData.currentLanguage === 'th' ? 'ลบงาน' : 'Delete Task';
                        deleteBtn.addEventListener('click', () => deleteTask(category.id, task.id));
                        actionButtonsDiv.appendChild(deleteBtn);
                    }
                    li.appendChild(actionButtonsDiv);
                    ul.appendChild(li);
                });
                categoryDiv.appendChild(ul);

                if (!isDoneCategory) { // Add task form only for non-Done categories
                    const addTaskForm = document.createElement('form'); /* ... form rendering ... */ 
                    addTaskForm.className = 'mt-4 flex items-center space-x-2';
                    addTaskForm.addEventListener('submit', (e) => { /* ... */ });
                    const taskInput = document.createElement('input'); /* ... */
                    taskInput.type = 'text';
                    taskInput.className = 'flex-grow p-2 border border-gray-300 dark:border-gray-500 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:text-gray-100';
                    taskInput.placeholder = getLocalizedText({text_th: 'เพิ่มงานใหม่...', text_en: 'Add new task...'});
                    const addTaskBtn = document.createElement('button'); /* ... */
                    addTaskBtn.type = 'submit';
                    addTaskBtn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition-colors';
                    addTaskBtn.textContent = getLocalizedText({text_th: 'เพิ่ม', text_en: 'Add'});
                    addTaskForm.appendChild(taskInput);
                    addTaskForm.appendChild(addTaskBtn);
                    categoryDiv.appendChild(addTaskForm);
                }
                taskArea.appendChild(categoryDiv);
            });
            updateUIForLanguage();
        };

        const enableTaskEdit = (spanElement, categoryId, taskId) => { /* ... same ... */ };
        const updateUIForLanguage = () => { /* ... same ... */ 
            document.documentElement.lang = appData.currentLanguage;
            appTitle.textContent = appData.currentLanguage === 'th' ? 'ครูพร้อมสอน' : "Teacher's Prep List";
            document.querySelectorAll('.lang-th').forEach(el => el.classList.toggle('hidden', appData.currentLanguage !== 'th'));
            document.querySelectorAll('.lang-en').forEach(el => el.classList.toggle('hidden', appData.currentLanguage !== 'en'));
            if(languageToggleBtn) languageToggleBtn.textContent = appData.currentLanguage === 'th' ? 'English' : 'ไทย';
        };
        const applyDarkMode = () => { /* ... same ... */ 
             if (appData.darkMode) {
                document.documentElement.classList.add('dark');
                if(themeToggleLightIcon) themeToggleLightIcon.classList.remove('hidden');
                if(themeToggleDarkIcon) themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                if(themeToggleDarkIcon) themeToggleDarkIcon.classList.remove('hidden');
                if(themeToggleLightIcon) themeToggleLightIcon.classList.add('hidden');
            }
        };

        const toggleTaskComplete = (currentDisplayCategoryId, taskId) => {
            if (!currentUser) return;

            let task, originalCategory, taskIndex;
            let isMovingToDone = false;

            // Find the task and its current category
            if (currentDisplayCategoryId === 'done') { // Task is currently in "Done" category
                originalCategory = findCategoryOrSubcategory('done', userTasks);
                task = originalCategory.items.find(t => t.id === taskId);
                if (!task) return;
                taskIndex = originalCategory.items.findIndex(t => t.id === taskId);
                isMovingToDone = false; // Will be moved back to original
            } else { // Task is in a regular category
                originalCategory = findCategoryOrSubcategory(currentDisplayCategoryId, userTasks);
                if (!originalCategory || !originalCategory.items) return;
                task = originalCategory.items.find(t => t.id === taskId);
                if (!task) return;
                taskIndex = originalCategory.items.findIndex(t => t.id === taskId);
                isMovingToDone = !task.completed; // If checking as complete, move to Done
            }

            if (!task) {
                console.error("Task not found for toggle:", taskId, "in category:", currentDisplayCategoryId);
                return;
            }

            task.completed = !task.completed; // Toggle completion status

            if (isMovingToDone) {
                // Moving to "Done"
                task.originalCategoryId = currentDisplayCategoryId; // Store where it came from
                originalCategory.items.splice(taskIndex, 1); // Remove from original category

                let doneCategory = findCategoryOrSubcategory('done', userTasks);
                if (!doneCategory) { // Should have been created by loadUserDataFromFirestore
                    console.error("'Done' category not found in userTasks!");
                    userTasks.push(JSON.parse(JSON.stringify(defaultTasksStructure.find(cat => cat.id === 'done')))); // Add it if missing
                    doneCategory = findCategoryOrSubcategory('done', userTasks);
                }
                doneCategory.items.push(task);
            } else if (currentDisplayCategoryId === 'done' && task.originalCategoryId) {
                // Moving back from "Done" to its original category
                const targetCategoryId = task.originalCategoryId;
                originalCategory.items.splice(taskIndex, 1); // Remove from "Done"

                const targetCategory = findCategoryOrSubcategory(targetCategoryId, userTasks);
                if (targetCategory) {
                    targetCategory.items.push(task);
                    task.originalCategoryId = null; // Clear originalCategoryId as it's back home
                } else {
                    console.warn("Original category not found for task, placing in first available category:", targetCategoryId);
                    // Fallback: add to the first non-done, non-sub-category category if original is somehow lost
                    const fallbackCat = userTasks.find(c => c.id !== 'done' && c.items);
                    if (fallbackCat) fallbackCat.items.push(task);
                    else userTasks[0].items.push(task); // Absolute fallback
                }
            }
            // If just unchecking within a normal category (isMovingToDone is false, currentDisplayCategoryId is not 'done'), it just stays.

            saveUserDataToFirestore();
            renderTasks();
        };
        
        const findOriginalTaskById = (taskId, tasksArray = userTasks) => { /* ... same ... */ 
             for (const mainCat of tasksArray) {
                if (mainCat.id === 'done' && mainCat.items) { // Check done category too
                    const task = mainCat.items.find(item => item.id === taskId);
                    if (task) return task;
                }
                if (mainCat.items && mainCat.id !== 'done') {
                    const task = mainCat.items.find(item => item.id === taskId);
                    if (task) return task;
                }
                if (mainCat.subCategories) {
                    for (const subCat of mainCat.subCategories) {
                        if (subCat.items) {
                            const task = subCat.items.find(item => item.id === taskId);
                            if (task) return task;
                        }
                    }
                }
            }
            return null;
        };

        const addNewTask = (displayCategoryId, taskText) => { /* ... same, ensure originalCategoryId: null ... */ 
            if (!currentUser) return;
            const newTask = {
                id: generateId(), text_th: taskText, text_en: taskText, 
                completed: false, isCustom: true, dueDate: null, notificationShown: false, originalCategoryId: null
            };
            // ... (language specific text setting)
            const originalCategory = findCategoryOrSubcategory(displayCategoryId, userTasks); 
            if (originalCategory && originalCategory.items && displayCategoryId !== 'done') { // Don't add new tasks to 'done'
                originalCategory.items.push(newTask);
                saveUserDataToFirestore();
                renderTasks();
            }
        };
        
        const updateTaskText = (displayCategoryId, taskId, newText) => { /* ... same ... */ };
        const deleteTask = (displayCategoryId, taskId) => { /* ... same, handles deletion from any category including "Done" ... */ 
             if (!currentUser) return;
            const category = findCategoryOrSubcategory(displayCategoryId, userTasks);
            if(category && category.items){
                 category.items = category.items.filter(t => t.id !== taskId);
                 saveUserDataToFirestore();
                 renderTasks();
            } else {
                console.error("Category not found for deletion or items array missing", displayCategoryId);
            }
        };
        const findOriginalCategoryForItem = (taskId, tasksArray = userTasks) => { /* ... same ... */ };
        const findCategoryOrSubcategory = (id, source = userTasks) => { /* ... same ... */ 
            for (let category of source) {
                if (category.id === id) return category;
                if (category.subCategories) { // Check subcategories
                    for (let subCategory of category.subCategories) {
                        if (subCategory.id === id) return subCategory;
                    }
                }
            }
            return null; // Return null if not found
        };
        const toggleDueDateEdit = (displayCategoryId, taskId, isEditing) => { /* ... same ... */ };
        const setTaskDueDate = async (displayCategoryId, taskId, dueDateValue) => { /* ... same ... */ };

        if(languageToggleBtn) languageToggleBtn.addEventListener('click', () => { /* ... same ... */ });
        if(darkModeToggleBtn) darkModeToggleBtn.addEventListener('click', () => { /* ... same ... */ });
        viewTabs.forEach(tab => { tab.addEventListener('click', () => { /* ... same ... */ }); });
        if(exportCsvBtn) exportCsvBtn.addEventListener('click', () => { 
            if (!currentUser) return;
            let csvContent = "\uFEFF"; 
            csvContent += `Category (${appData.currentLanguage}),Task (${appData.currentLanguage}),Status (${appData.currentLanguage}),Due Date (${appData.currentLanguage})\n`;
            
            const processCategoryForCSV = (cat, isDoneCat = false) => {
                const categoryTitle = getLocalizedText(cat, 'title');
                cat.items.forEach(task => {
                    let taskText = getLocalizedText(task);
                    taskText = `"${taskText.replace(/"/g, '""')}"`; 
                    const status = isDoneCat ? 
                        (appData.currentLanguage === 'th' ? 'เรียบร้อยแล้ว' : 'Done') : 
                        (task.completed ? (appData.currentLanguage === 'th' ? 'เสร็จแล้ว (ในหมวดหมู่เดิม)' : 'Completed (in original cat)') : (appData.currentLanguage === 'th' ? 'ยังไม่เสร็จ' : 'Pending'));
                    const dueDateFormatted = task.dueDate ? formatDueDate(task.dueDate) : '';
                    csvContent += `"${categoryTitle}",${taskText},"${status}","${dueDateFormatted}"\n`;
                });
            };

            userTasks.filter(cat => cat.id !== 'done').forEach(cat => { // Process non-done categories
                if (cat.items) processCategoryForCSV(cat);
                else if (cat.subCategories) cat.subCategories.forEach(subCat => processCategoryForCSV(subCat));
            });
            
            const doneCategory = userTasks.find(cat => cat.id === 'done'); // Process done category
            if (doneCategory) processCategoryForCSV(doneCategory, true);

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
            link.setAttribute("download", `kru_prom_sorn_all_tasks_${appData.currentLanguage}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        });

        const initApp = () => { /* ... same ... */ 
            const localSettings = JSON.parse(localStorage.getItem('thaiTeacherTodoLocalSettings')) || {};
            appData.currentLanguage = localSettings.currentLanguage || 'th';
            appData.darkMode = localSettings.darkMode !== undefined ? localSettings.darkMode : false;
            applyDarkMode(); 
            updateUIForLanguage(); 
            window.addEventListener('beforeunload', () => { /* ... */ });
            setInterval(checkAndShowReminders, 60000);
        };
        initApp();
    </script>
</body>
</html>
